<html><head><script type="text/javascript">
var add_url = "https://1m7vgd21ee.execute-api.us-east-2.amazonaws.com/Beta/schedule/";

var ts; // timeslots list
var startFullDate; // start date of the calendar
var endFullDate; // end date of the calendar
var weekStart; // start date for the shown week
var weekEnd; // end date for the shown week

function showNextWeek(){
  // check to make sure were not at the end the the schedule
  // change start week, then call showTimeSlotsGUI()
  if(endFullDate.getTime() == weekEnd.getTime()){
    return;
  }

  weekStart.setDate(weekEnd.getDate());

  showTimeSlotsGUI(ts);

}

function showLastWeek(){
  // check to make sure were not at the beginning of the the schedule
  // change start week, then call showTimeSlotsGUI()
  if(startFullDate.getTime() == weekStart.getTime()){
    return;
  }

  weekStart.setDate(weekStart.getDate() - 7);

  showTimeSlotsGUI(ts);
}

function showTimeSlotsGUI(timeslots){
  var rowCounter = 0;
  var columnCounter = 0;
  var rows = document.getElementById("schedule").rows;

  var cell;
  var slotEndDate;
  var slotStartDate;
  for(var i=0; i<timeslots.length;i++){
    // if the timeslot end time is greater than or equal to the endtime of the end date
    // and the timeslot start time is less than or equal to the starttime of the start date
    slotEndDate = new Date(timeslots[i].enddate+"T"+timeslots[i].endtime+"Z");
    slotStartDate = new Date(timeslots[i].startdate+"T"+timeslots[i].starttime+"Z");
    if(Math.abs(slotStartDate.getTime()) <= Math.abs(weekStart.getTime()) && rowCounter < rows.length-1){
      // insert cell
      // increment column counter
      // check if column counter is at 7, then increment rowCounter
      cell = rows[rowCounter].cells[columnCounter];
      cell.innerHTML = timeslots[i].startime+" "+timeslots[i].secretcode;
      column++;

      if(columnCounter == 7){rowCounter++;}

      if (i==timeslots.length-1){
        weekEnd = new Date(timeslots[i].enddate+"T"+timeslots[i].endtime+"Z");
        return;
      }
    } else {
      weekEnd = new Date(timeslots[i-1].enddate+"T"+timeslots[i-1].endtime+"Z");
      return;
    }
  }

}

function showScheduleGUI(startdate, enddate, daystarthour, dayendhour, slotlength, timeslots){
  startFullDate = new Date(startdate+"T"+daystarthour+"Z");
  endFullDate = new Date(enddate+"T"+dayendhour+"Z");
  // weekstart is the start date of the shown week
  weekStart = new Date(timeslots[0].startdate+"T"+timeslots[0].starttime+"Z");
  ts = timeslots;
  document.getElementById("schedule").innerHTML = "";

  var table = document.getElementById("schedule");
  var header = table.createTHead();
  var row = header.insertRow(0);
  var timeh = row.insertCell(0);
  timeh.innerHTML = "<b>Meeting Times</b>";
  var day;

  var date = new Date(startdate+"T"+daystarthour+"Z");
  //console.log(date.toUTCString());
  var date2 = new Date(enddate+"T"+dayendhour+"Z");
  //console.log(date2.toUTCString());
  var DOWdate = new Date(startdate+"T"+daystarthour+"Z");
  // Days of the Week at the top of the table
  for(var i=0;i<7;i++){
    day = row.insertCell(i+1);
    DOWdate.setDate(date.getDate()+i);
    var string = DOWdate.toUTCString().slice(0, 12);
    day.innerHTML = "<b>" + string + "</b>";
  }

  // Insert rows for every meeting slot
  var slot;
  date = new Date(startdate+"T"+daystarthour+"Z");
  //console.log(date.toUTCString());
  date2 = new Date(startdate+"T"+dayendhour+"Z");
  var meetingStartDate = new Date(startdate+"T"+daystarthour+"Z");
  var meetingEndDate = new Date(startdate+"T"+daystarthour+"Z");
  var numcolumns = parseInt((date.getTime()-date2.getTime())/(slotlength*60000));
  for(var i=0;i<Math.abs(numcolumns);i++){
    row = table.insertRow();
    slot = row.insertCell(0);
    for(var j=0;j<7;j++){
      row.insertCell();
    }

    var meetingStart = date.getTime()+((slotlength*60000)*i);
    var meetingEnd = date.getTime()+((slotlength*60000)*(i+1));

    meetingStartDate.setTime(meetingStart);
    //console.log(meetingStartDate.toUTCString());
    meetingEndDate.setTime(meetingEnd);
    //console.log(meetingEndDate.toUTCString());
    slot.innerHTML = "<b>" + meetingStartDate.toUTCString().slice(17,25) + " - " + meetingEndDate.toUTCString().slice(17,25) + "</b>";
  }

  // add the week buttons
  var buttons = document.getElementById("changeweek");
  buttons.innerHTML = "<button onclick='showNextWeek'>Next Week</button> <button onclick='showLastWeek'>Last Week</button>";

  showTimeSlotsGUI(timeslots);
}

function showSchedule(startdate, enddate, daystarthour, dayendhour, slotlength){
  var form = document.showForm;
  var scheduleid = form.scheduleid.value;

  var data = {};
  data["scheduleid"] = scheduleid;

  var js = JSON.stringify(data);
  console.log("JS:" + js);
  var xhr = new XMLHttpRequest();
  xhr.open("GET", show_url, true);

  // send the collected data as JSON
  xhr.send(js);

  // This will process results and update HTML as appropriate.
  xhr.onloadend = function () {
    console.log(xhr);
    console.log(xhr.request);
    if (xhr.readyState == XMLHttpRequest.DONE) {
      console.log ("XHR:" + xhr.responseText);
      if(xhr.status == 200){
        var timeslots = JSON.parse(xhr.responseText);
        console.log(timeslots);
        showScheduleGUI(startdate, enddate, daystarthour, dayendhour, slotlength, timeslots);
      }
    }
  };

}

function createScheduleID(js){
  document.getElementById("message").innerHTML = "secret code: "+ js.response;
}

function createSchedule(e) {
  var form = document.createForm;
  var startdate = form.startdate.value;
  var enddate = form.enddate.value;
  var daystarthour = form.daystarthour.value;
  var dayendhour = form.dayendhour.value;
  var organizer = form.organizer.value;
  var slotlength = form.slotlength.value;

  var data = {};
  data["startdate"] = startdate;
  data["enddate"] = enddate;
  data["daystarthour"] = daystarthour;
  data["dayendhour"] = dayendhour;
  data["organizer"] = organizer;
  data["meetinglength"] = slotlength;

  var js = JSON.stringify(data);
  console.log("JS:" + js);
  var xhr = new XMLHttpRequest();
  xhr.open("POST", add_url, true);

  // send the collected data as JSON
  xhr.send(js);

  // This will process results and update HTML as appropriate.
  xhr.onloadend = function () {
    if (xhr.readyState == XMLHttpRequest.DONE) {
      console.log ("XHR:" + xhr.responseText);
      if(xhr.status == 200){
        var js = JSON.parse(xhr.responseText);
        createScheduleID(js);
      }
    }
  };
}

</script></head><body>

<div id="message"></div>

<div class="container">

  <h1>Request to create a calendar </h1>

  <form name="createForm" method="post" >
    Start date (YYYY-MM-DD): <input name="startdate" value="" /><br>
    End date (YYYY-MM-DD): <input name="enddate" value="" /><br>
    Start time for each day (HH:MM:SS): <input name="daystarthour" value="" /><br>
    End time for each day (HH:MM:SS): <input name="dayendhour" value="" /><br>
    Meeting Length (minutes): <input name="slotlength" value="" /><br>
    Your name: <input name="organizer" value="" /><br>
    <input type="button" value="Submit"  onClick="JavaScript:createSchedule(this)">
  </form>

</div>

<div class="container">

  <h1>Request to show the schedule</h1>

  <form name="showForm" method="get">
    Input Schedule ID: <input name="scheduleid" value="" /><br>
    <input type="button" value="Show"  onClick="JavaScript:showSchedule(this)">
  </form>

</div>

<div class="container">

  <h3>Schedule</h3>

  <table id="schedule" border="black"></table>

  <div id="changeweek"></div>

</div>

</body>
</html>
