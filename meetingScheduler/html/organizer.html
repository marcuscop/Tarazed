<html>
<head>

<!-- jQuery -->
<script src="motion/js/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="motion/js/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="motion/js/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="motion/js/jquery.waypoints.min.js"></script>
<!-- Main -->
<script src="motion/js/main.js"></script>
<!-- Modernizr JS -->
<script src="motion/js/modernizr-2.6.2.min.js"></script>
<!-- style.css -->
<link rel="stylesheet" href="motion/css/style.css">
<!-- Animate.css -->
<link rel="stylesheet" href="motion/css/animate.css">
<!-- Icomoon Icon Fonts-->
<link rel="stylesheet" href="motion/css/icomoon.css">
<!-- Themify Icons-->
<link rel="stylesheet" href="motion/css/themify-icons.css">
<!-- Bootstrap  -->
<link rel="stylesheet" href="motion/css/bootstrap.css">
<!-- Theme style  -->
<link rel="stylesheet" href="motion/css/style.css">


<script type="text/javascript">
var add_url = "https://rbnqasw5vg.execute-api.us-east-2.amazonaws.com/Alpha/schedule";
var close_time_slot = "https://rbnqasw5vg.execute-api.us-east-2.amazonaws.com/Alpha/close-time-slot";
var open_time_slot = "https://rbnqasw5vg.execute-api.us-east-2.amazonaws.com/Alpha/open-time-slot";

var ts; // timeslots list
var startFullDate; // start date of the calendar
var endFullDate; // end date of the calendar
var weekStart; // start date for the shown week
var weekEnd; // end date for the shown week
var columnmax; // the difference in days between start day and end day, in days

function showNextWeek(){
  // check to make sure were not at the end the the schedule
  // change start week, then call showTimeSlotsGUI()
  if(endFullDate.getTime() == weekEnd.getTime()){
    return;
  }

  weekStart.setDate(weekEnd.getDate());

  showTimeSlotsGUI(ts);

}

function showLastWeek(){
  // check to make sure were not at the beginning of the the schedule
  // change start week, then call showTimeSlotsGUI()
  if(startFullDate.getTime() == weekStart.getTime()){
    return;
  }

  weekStart.setDate(weekStart.getDate() - 7);

  showTimeSlotsGUI(ts);
}

function showTimeSlotsGUI(timeslots){
  var rowCounter = 1;
  var columnCounter = 1;
  var cell;
  var slotEndDate;
  var slotStartDate;
  if(columnmax>7){columnmax=7}

  var rows = document.getElementById("schedule").rows;

  for(var i=0; i<timeslots.list.length;i++){
    slotEndDate = new Date(timeslots.list[i].enddate+"T"+timeslots.list[i].endtime+"Z");
    slotStartDate = new Date(timeslots.list[i].startdate+"T"+timeslots.list[i].starttime+"Z");
    if(slotStartDate.getTime() >= weekStart.getTime() && columnCounter <= columnmax){
      // insert cell
      // increment column counter
      // check if column counter is at 7, then increment rowCounter
      cell = rows[rowCounter].cells[columnCounter];
      if(timeslots.list[i].available == 1){
        cell.innerHTML = '<p id="'+ timeslots.list[i].id + '">' + timeslots.list[i].participant + '</p><button class="btn-xs" id="' + timeslots.list[i].secretcode + '" onclick="openTimeSlot(this)" value="UNAVAILABLE" style="color:#FFA07A">UNAVAILABLE</button>';
      } else {
        cell.innerHTML = '<p id="'+ timeslots.list[i].id + '"></p><button class="btn-xs" id="' + timeslots.list[i].secretcode + '" onclick="closeTimeSlot(this)" value="OPEN" style="color:#99FF99">OPEN</button>';
      }

      if(rowCounter == rows.length-1){
        columnCounter++;
        rowCounter = 1;
      } else {
        rowCounter++;
      }
    } else {
      weekStart = new Date(slotStartDate.getTime());
      weekEnd = new Date(slotEndDate.getTime());
      console.log(weekStart.toUTCString());
      console.log(weekEnd.toUTCString());
    }
  }

}

function getSlotLength(timeslots){
  var date1 = new Date(timeslots.list[0].startdate+"T"+timeslots.list[0].starttime+"Z");
  var date2 = new Date(timeslots.list[0].startdate+"T"+timeslots.list[0].endtime+"Z");
  var slotlength = (Math.abs(date1.getTime() - date2.getTime()))/60000;
  return slotlength;
}

function getEarliestDate(timeslots){
  var tempDate;
  var earliestDate = new Date(timeslots.list[0].startdate+"T"+timeslots.list[0].starttime+"Z");
  // find the startdate
  for(var i=0; i<timeslots.list.length; i++){
    tempDate = new Date(timeslots.list[i].startdate+"T"+timeslots.list[i].starttime+"Z");
    if(tempDate.getTime() < earliestDate.getTime()){
      earliestDate = new Date(tempDate.getTime());
    }
  }
  return earliestDate;
}

function getLatestDate(timeslots){
  var tempDate;
  var latestDate = new Date(timeslots.list[0].startdate+"T"+timeslots.list[0].starttime+"Z");
  // find the enddate
  for(var i=0; i<timeslots.list.length; i++){
    tempDate = new Date(timeslots.list[i].enddate+"T"+timeslots.list[i].endtime+"Z");
    if(tempDate.getTime() > latestDate.getTime()){
      latestDate = new Date(tempDate.getTime());
    }
  }
  return latestDate;
}

function getStartDOYString(timeslots){
   return timeslots.list[0].startdate;
}

function getEndTString(timeslots){
  var tempDate;
  var endTime;
  var latestDate = new Date(timeslots.list[0].startdate+"T"+timeslots.list[0].starttime+"Z");
  // find the startdate
  for(var i=0; i<timeslots.list.length; i++){
    tempDate = new Date(timeslots.list[i].enddate+"T"+timeslots.list[i].endtime+"Z");
    if(tempDate.getTime() > latestDate.getTime()){
      endTime = timeslots.list[i].endtime;
      latestDate = new Date(tempDate.getTime());
    }
  }
  return endTime;
}

function drawScheduleSkeleton(earliestDate, slotlength, startDate, endTime){
  // Insert rows for every schedule
  var slot;
  var row;
  var table = document.getElementById("schedule");
  var date = new Date(earliestDate.getTime());
  console.log("earliest: " + date.toUTCString());
  var date2 = new Date(startDate+"T"+endTime+"Z");
  console.log(startDate);
  console.log(endTime);
  console.log("end time on same day: " + date2.toUTCString());
  console.log("slotlength: " + slotlength);
  var meetingStartDate = new Date(earliestDate.getTime());
  var meetingEndDate = new Date(earliestDate.getTime());
  var numcolumns = parseInt((date.getTime()-date2.getTime())/(slotlength*60000));
  for(var i=0;i<Math.abs(numcolumns);i++){
    row = table.insertRow();
    slot = row.insertCell(0);
    for(var j=0;j<7;j++){
      row.insertCell();
    }

    var meetingStart = date.getTime()+((slotlength*60000)*i);
    var meetingEnd = date.getTime()+((slotlength*60000)*(i+1));

    meetingStartDate.setTime(meetingStart);
    console.log(meetingStartDate.toUTCString());
    meetingEndDate.setTime(meetingEnd);
    console.log(meetingEndDate.toUTCString());
    slot.innerHTML = "<b>" + meetingStartDate.toUTCString().slice(17,22) + " - " + meetingEndDate.toUTCString().slice(17,22) + "</b>";
  }
}

function drawScheduleHeader(earliestDate, latestDate){
  var table = document.getElementById("schedule");
  var header = table.createTHead();
  var row = header.insertRow(0);
  var timeh = row.insertCell(0);
  timeh.innerHTML = "<b>Meeting Times</b>";
  var day;

  var date = new Date(earliestDate.getTime());
  //console.log(date.toUTCString());
  var date2 = new Date(latestDate.getTime());
  //console.log(date2.toUTCString());
  var DOWdate = new Date(earliestDate.getTime());
  // Days of the Week at the top of the table
  for(var i=0;i<7;i++){
    day = row.insertCell(i+1);
    DOWdate.setTime(date.getTime()+(i*1000*60*60*24));
    var string = DOWdate.toUTCString().slice(0, 12);
    console.log(string);
    day.innerHTML = string;
  }
}

function showScheduleSC(js){
  document.getElementById("message").value = js.scheduleid;
}

function showScheduleGUI(timeslots){
  ts = timeslots;

  var slotlength = getSlotLength(timeslots);
  var startDate = getStartDOYString(timeslots);
  var endTime = getEndTString(timeslots);
  var latestDate = getLatestDate(timeslots);
  var earliestDate = getEarliestDate(timeslots);

  columnmax = Math.floor(1+Math.abs((getEarliestDate(timeslots).getTime()-getLatestDate(timeslots).getTime())/(1000*60*60*24)));
  //columnmax = Math.abs(getLatestDate(timeslots).getDate() - getEarliestDate(timeslots).getDate())+1;
  startFullDate = new Date(earliestDate.getTime());
  endFullDate = new Date(latestDate.getTime());
  weekStart = new Date(earliestDate.getTime());
  console.log("\n\n\n\n\nEarliest Time: "+endFullDate.getTime());

  document.getElementById("schedule").innerHTML = "";

  drawScheduleHeader(earliestDate, latestDate);

  drawScheduleSkeleton(earliestDate, slotlength, startDate, endTime);


  showTimeSlotsGUI(timeslots);
}

function showSchedule(){
  var form = document.showForm;
  var secretcode = form.secretcode.value;

  //var data = {};
  //data["scheduleid"] = scheduleid;

  var params = "secretcode="+secretcode;
  //var js = JSON.stringify(data);
  console.log("request: " + params);
  var xhr = new XMLHttpRequest();
  xhr.open("GET", add_url+"?"+params, true);

  // send the collected data as JSON
  xhr.send();

  // This will process results and update HTML as appropriate.
  xhr.onloadend = function () {
    console.log(xhr);
    console.log(xhr.request);
    if (xhr.readyState == XMLHttpRequest.DONE) {
      console.log ("XHR:" + xhr.responseText);
      if(xhr.status == 200){
        var timeslots = JSON.parse(xhr.responseText);
        console.log(timeslots);
        showScheduleGUI(timeslots);
        showScheduleSC(timeslots.list[0]);
      }
    }
  };

}

function createScheduleSC(js){
  document.getElementById("message").value = js.scheduleid;
  document.getElementById("secretcode").value = js.secretcode;
}

function createSchedule(e) {
  var form = document.createForm;
  var startdate = form.startdate.value;
  var enddate = form.enddate.value;
  var daystarthour = form.daystarthour.value;
  var dayendhour = form.dayendhour.value;
  var organizer = form.organizer.value;
  var slotlength = form.slotlength.value;

  var data = {};
  data["startdate"] = startdate;
  data["enddate"] = enddate;
  data["daystarthour"] = daystarthour;
  data["dayendhour"] = dayendhour;
  data["organizer"] = organizer;
  data["meetinglength"] = slotlength;

  var js = JSON.stringify(data);
  console.log("JS:" + js);
  var xhr = new XMLHttpRequest();
  xhr.open("POST", add_url, true);

  // send the collected data as JSON
  xhr.send(js);

  // This will process results and update HTML as appropriate.
  xhr.onloadend = function () {
    if (xhr.readyState == XMLHttpRequest.DONE) {
      console.log ("XHR:" + xhr.responseText);
      if(xhr.status == 200){
        var js = JSON.parse(xhr.responseText);
        createScheduleSC(js);
      }
    }
  };
}

function removeParticipantInCell(startdate, starttime, response){
  for(var i=0; i<ts.list.length;i++){
    if(ts.list[i].starttime == starttime && ts.list[i].startdate == startdate){
      ts.list[i].participant = "";
      document.getElementById(ts.list[i].id).innerHTML = "";
      console.log(ts.list[i].id);
      console.log("ts starttime:" + ts.list[i].starttime);
      console.log("cell starttime:" + starttime);
      console.log("ts starttime:" + ts.list[i].startdate);
      console.log("cell starttime:" + startdate);

    }
  }

}

function openTimeSlot(e){
  var sID;  // string
	var starttime; // string
	var startdate; // string
	var close; // int

  // search for a timeslot with a matching secretcode
  for(var i=0; i<ts.list.length; i++){
    if(e.id == ts.list[i].secretcode){
      sID = ts.list[i].scheduleid;
    	starttime = ts.list[i].starttime;
    	startdate = ts.list[i].startdate;
    	close = 0;
    }
  }

  var data = {};
  data["sID"] = sID;
  data["startdate"] = startdate;
  data["starttime"] = starttime;
  data["close"] = close;

  openTimeSlotRequest(e, data);

}

function openTimeSlotRequest(e, data){
  var js = JSON.stringify(data);
  console.log("JS:" + js);
  var xhr = new XMLHttpRequest();
  xhr.open("POST", open_time_slot, true);

  // send the collected data as JSON
  xhr.send(js);

  // This will process results and update HTML as appropriate.
  xhr.onloadend = function () {
    if (xhr.readyState == XMLHttpRequest.DONE) {
      console.log ("XHR:" + xhr.responseText);
      if(xhr.status == 200){
        var js = JSON.parse(xhr.responseText);
        document.getElementById(e.id).onclick = function () {
    	    closeTimeSlot(this);
        }
        document.getElementById(e.id).value = "OPEN";
        document.getElementById(e.id).innerHTML = "OPEN";
        document.getElementById(e.id).style.color = "#99FF99";
        removeParticipantInCell(data.startdate, data.starttime, js.response);
      }
    }
  };
}

function closeTimeSlot(e){
  var sID;  // string
	var starttime; // string
	var startdate; // string
	var close; // int

  // search for a timeslot with a matching secretcode
  for(var i=0; i<ts.list.length; i++){
    if(e.id == ts.list[i].secretcode){
      sID = ts.list[i].scheduleid;
    	starttime = ts.list[i].starttime;
    	startdate = ts.list[i].startdate;
    	close = 1;
    }
  }

  var data = {};
  data["sID"] = sID;
  data["startdate"] = startdate;
  data["starttime"] = starttime;
  data["close"] = close;

  closeTimeSlotRequest(e, data);
}

function closeTimeSlotRequest(e, data){
  var js = JSON.stringify(data);
  console.log("JS:" + js);
  var xhr = new XMLHttpRequest();
  xhr.open("POST", close_time_slot, true);

  // send the collected data as JSON
  xhr.send(js);

  // This will process results and update HTML as appropriate.
  xhr.onloadend = function () {
    if (xhr.readyState == XMLHttpRequest.DONE) {
      console.log ("XHR:" + xhr.responseText);
      if(xhr.status == 200){
        var js = JSON.parse(xhr.responseText);
        document.getElementById(e.id).onclick = function () {
    	    openTimeSlot(this);
        }
        document.getElementById(e.id).value = "UNAVAILABLE";
        document.getElementById(e.id).innerHTML = "UNAVAILABLE";
        document.getElementById(e.id).style.color = "#FFA07A";
      }
    }
  };
}

</script></head><body>


<div id = "page">

  <nav class="gtco-nav" role="navigation">
    <div class="container">

      <div class="row">
        <div class="col-sm-2 col-xs-2">
          <div id="gtco-logo"><a href="index.html">Tarazed</div>
        </div>
        <div class="col-xs-10 text-right fh5co-top-social">
          <ul class="gtco-social">
            <li><a href="https://github.com/marcuscop/Tarazed" class="icon-github"></i></a></li>
          </ul>
        </div>
      </div>

    </div>
  </nav>

  <div id="gtco-intro">

      <div class="row">

        <div class="col-md-4">
            <div class="dtc animate-box">
              <form name="createForm" method="post" >
                <div class="list-group">
                  <fieldset>
                    <div class="list-group-item">
                      <legend class="">Create Schedule</legend>
                    </div>
                    <div class="list-group-item">
                      Start Date<br><input type="search" name="startdate" value="YYYY-MM-DD" />
                    </div>
                    <div class="list-group-item">
                      End Date <br><input type="search" name="enddate" value="YYYY-MM-DD" />
                    </div>
                    <div class="list-group-item">
                      Start Time <br><input type="search" name="daystarthour" value="HH:MM:SS" />
                    </div>
                    <div class="list-group-item">
                      End Time <br><input type="search" name="dayendhour" value="HH:MM:SS" />
                    </div>
                    <div class="list-group-item">
                      Meeting Length (min) <br><input type="search" name="slotlength" value="30" />
                    </div>
                    <div class="list-group-item">
                      Name <br><input type="search" name="organizer" value="" /><br>
                    </div>
                    <div class="list-group-item">
                      <legend></legend>
                      <input class="btn" type="button" value="Submit"  onClick="JavaScript:createSchedule(this)">
                    </div>

                  </fieldset>
                </div>
              </form>
            </div>
        </div>

        <div class="col-md-7">
          <div class="dtc animate-box">

              <form name="showForm" method="get">
                  <div class="list-group-2">
                    <fieldset>
                      <div class="list-group-2-item">
                        <div class="dl-horizontal">
                          <legend>Secret Code</legend>
                          <div class="list-group-2-item">

                          </div>
                          <div class="list-group-2-item">
                            <input type="search" id="message" value="" disabled/>
                            <input type="search" id="secretcode" name="secretcode" value="" />
                          </div>
                        </div>
                      </div>
                      <div class="list-group-2-item">
                        <input class="btn" type="button" value="Show Me!"  onClick="JavaScript:showSchedule()">
                      </div>
                    </fieldset>
                  </div>
              </form>

            <div class="calendar">
              <table class="table" id="schedule"></table>
              <div id="changeweek"></div>
            </div>

          </div>
        </div>

      </div>

  </div>

</div>

</body>
</html>
